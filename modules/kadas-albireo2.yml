name: kadas-albireo2
sources:
  - type: git
    url: https://github.com/kadas-albireo/kadas-albireo2.git
    branch: main
    commit: d142d2c7e8c09626b8edc0020d28f3a1b733e8ee

  - type: file
    url: https://github.com/kadas-albireo/kadas-albireo2/raw/ac0400fe6d8af6a688cb7064ba102b001df9b86c/share/geodata/dtm_swiss_only.tif
    sha256: 95bf6afbc0841d8c0d963bca97e4ff838dff2c9fd26ce82fdc564ece3725d736
    dest: share/geodata/

  - type: shell
    commands:
      - EPOCH=$(date +%s) && sed -i "s/1580472000/$EPOCH/g" com.sourcepole.kadas.appdata.xml #set date
      - VERSION=$(date -I) && sed -i "s/v2.0.0-rc1/$VERSION/g" com.sourcepole.kadas.appdata.xml #set version
      - DATE=$(date '+%Y%m%d%H%M') && sed -i "s/201911010130/$DATE/g" share/settings_patch.ini #cosmetic
      - git grep -l '${Python_SITEARCH}' | xargs sed -i 's/\${Python_SITEARCH}/\/app\/lib\/python3.12\/site-packages/g' #crude fix for forcing cmake setting site-packages to /app instead of /usr
      - sed -i 's/SET(SIP_CONCAT_PARTS 17)/SET(SIP_CONCAT_PARTS 10)/g' cmake/SIPMacros.cmake #try to "significantly speed up the build"
      - sed -i 's/#include <zonedetect\/zonedetect.h>/#include <zonedetect.h>/g' kadas/core/kadascoordinateutils.cpp #find zonedetect.h
      - sed -i '/find_package(GeographicLib REQUIRED)/a\find_package(exiv2 REQUIRED)'
        kadas/gui/CMakeLists.txt #find Exiv2

      - git grep -l '#include <qgis/' | xargs sed -i 's/#include <qgis\//#include </g' #nuclear fix for removing superfluous qgis folder
      - sed -i 's/#include <qgsnetworklogger.h>/#include <\/app\/lib\/debug\/source\/qgis\/src\/app\/devtools\/networklogger\/qgsnetworklogger.h>/g' kadas/app/kadasapplication.cpp #find qgsnetworklogger.h
      
      - sed -i 's/#include <QSqlDatabase>/#include <\/usr\/include\/QtSql\/QSqlDatabase>/g'
        /app/include/qgis/qgsauthmanager.h #find QtSql stuff
      - sed -i 's/#include <QSqlError>/#include <\/usr\/include\/QtSql\/QSqlError>/g'
        /app/include/qgis/qgsauthmanager.h #find QtSql stuff
      - sed -i 's/#include <QSqlQuery>/#include <\/usr\/include\/QtSql\/QSqlQuery>/g'
        /app/include/qgis/qgsauthmanager.h #find QtSql stuff
      
      - sed -i '/symbolForFeature( feature, QgsRenderContext() )->color();/i QgsRenderContext
        context;' kadas/app/kadasapplayerhandling.cpp #fix QgsRenderContext
      - sed -i 's/symbolForFeature( feature, QgsRenderContext() )->color();/symbolForFeature(
        feature, context )->color();/g' kadas/app/kadasapplayerhandling.cpp #fix QgsRenderContext

buildsystem: cmake-ninja
builddir: true
config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  - -DCMAKE_PREFIX_PATH=/app;/usr
  - -DWITH_VCPKG=OFF
  - -DINSTALL_SWISS_DTM=ON
  - -DINSTALL_ALBIREO_SETTINGS=ON
