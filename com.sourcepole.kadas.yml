app-id: com.sourcepole.kadas
branch: development
runtime: org.kde.Platform
runtime-version: "5.15-22.08"
base: io.qt.qtwebkit.BaseApp
base-version: "5.15-22.08"
sdk: org.kde.Sdk
command: kadas
rename-icon: kadas
#
separate-locales: false
finish-args:
  - --share=network
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --filesystem=home #easier to work with local layers
#
modules:
  - name: pypi-numpy #for cmake function findpython, makes gdal find python and modules
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c5/21/275cfa7731ee2e121b1bf85ddb21b8712fe2f409f02a8b61521af6e4993d/numpy-1.24.2-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: a51725a815a6188c662fb66fb32077709a9ca38053f0274640293a14fdd22978
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --no-index --prefix /app numpy-1.24.2-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
#
  - name: pypi-lxml #required by kadas-gpkg-plugin
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/89/9c/be3ebeb6053c6625c0497f282e0d8acc36c309212d47201e9cb1198ffb54/lxml-4.9.2-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.manylinux_2_24_x86_64.whl
        sha256: 1ab8f1f932e8f82355e75dda5413a57612c6ea448069d4fb2e217e9a4bed13d4
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --no-index --prefix /app lxml-4.9.2-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.manylinux_2_24_x86_64.whl
#
  - name: libzip
    sources:
      - type: git
        url: https://github.com/nih-at/libzip.git
        tag: v1.9.2
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
      - "-DBUILD_REGRESS=OFF"
      - "-DBUILD_EXAMPLES=OFF"
      - "-DBUILD_DOC=OFF"
#
  - name: minizip #required by quazip and libspatialite?
    sources:
      - type: git
        url: https://github.com/madler/zlib.git
        tag: v1.2.13
    buildsystem: simple
    builddir: true
    subdir: contrib/minizip
    build-commands:
      - rm -f Makefile
      - autoreconf -fiv
      - ./configure --prefix=/app
      - make
      - make install
#
  - name: quazip
    sources:
      - type: git
        url: https://github.com/stachenov/quazip.git
        tag: v1.4
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
#
  - name: glu #for grass opengl
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/mesa/glu.git
        tag: glu-9.0.2
    buildsystem: simple
    builddir: true
    build-commands:
      - ./autogen.sh
      - ./configure --prefix=/app
      - make
      - make install
#
  - name: opencl-headers
    sources:
      - type: git
        url: https://github.com/KhronosGroup/OpenCL-Headers.git
        tag: v2023.02.06
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
#
  - name: gsl
    sources:
      - type: git
        url: https://git.savannah.gnu.org/git/gsl.git
        tag: release-2-7
    buildsystem: simple
    builddir: true
    build-commands:
      - ./autogen.sh
      - ./configure --prefix=/app
      - make
      - make install
#
  - name: qtkeychain
    sources:
      - type: git
        url: https://github.com/frankosterfeld/qtkeychain.git
        tag: v0.13.2
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
      - "-DLIBSECRET_SUPPORT=OFF"
      - "-DBUILD_TRANSLATIONS=OFF"
#
  - name: geos
    sources:
      - type: git
        url: https://github.com/libgeos/geos.git
        tag: 3.11.1
        #tag: 3.8.3 #works with osgearth-2.10.x
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
      - "-DUSE_CCACHE=ON"
      - "-DGEOS_BUILD_DEVELOPER=OFF"
#
  - name: tcl
    sources:
      - type: git
        url: https://github.com/tcltk/tcl.git
        tag: core-8-6-13
    buildsystem: simple
    builddir: true
    subdir: unix
    build-commands:
      - ./configure --prefix=/app --enable-64bit
      - make
      - make install
    post-install:
      - chmod 755 /app/lib/libtcl*.so
#
  - name: sqlite3
    sources:
      - type: git
        url: https://github.com/sqlite/sqlite.git
        tag: version-3.40.1
    buildsystem: simple
    builddir: true
    build-commands:
      - CFLAGS="-DSQLITE_ENABLE_COLUMN_METADATA=1" ./configure --prefix=/app --enable-all #enable-all is only; fts4/5 geopoly rtree session
      - make
      - make install
#
  - name: proj
    sources:
      - type: git
        url: https://github.com/OSGeo/PROJ.git
        tag: 9.1.1
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
      - "-DUSE_CCACHE=ON"
      - "-DBUILD_TESTING=OFF"
#
  - name: librttopo #stale, last change 1 year ago
    sources:
      - type: git
        url: https://git.osgeo.org/gitea/rttopo/librttopo.git
        tag: librttopo-1.1.0
    buildsystem: simple
    builddir: true
    build-commands:
      - ./autogen.sh
      - ./configure --prefix=/app
      - make
      - make install
#
  - name: freexl
    sources:
      - type: archive
        url: https://www.gaia-gis.it/gaia-sins/freexl-1.0.6.tar.gz
        sha256: 3de8b57a3d130cb2881ea52d3aa9ce1feedb1b57b7daa4eb37f751404f90fc22
    buildsystem: simple
    builddir: true
    build-commands:
      - ./configure --prefix=/app
      - make
      - make install
#
  - name: libspatialite #stale, last change 2 years ago
    sources:
      - type: archive
        url: https://www.gaia-gis.it/gaia-sins/libspatialite-5.0.1.tar.gz
        sha256: eecbc94311c78012d059ebc0fae86ea5ef6eecb13303e6e82b3753c1b3409e98
    buildsystem: simple
    builddir: true
    build-commands:
      - ./configure --prefix=/app --enable-examples=no #--enable-minizip=no if minizip isn't installed
      - make
      - make install
#
  - name: libspatialindex
    sources:
      - type: git
        url: https://github.com/libspatialindex/libspatialindex.git
        tag: 1.9.3
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
#
  - name: hdf5
    sources:
      - type: git
        url: https://github.com/HDFGroup/hdf5.git
        tag: hdf5-1_13_2 #works with netcdf-c 4.9.0
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
      - "-DHDF5_ENABLE_Z_LIB_SUPPORT=ON" #for netcdf-c
      - "-DHDF5_BUILD_CPP_LIB=ON" #for gdal
      - "-DBUILD_TESTING=OFF"
      - "-DHDF5_BUILD_EXAMPLES=OFF"
#
  - name: netcdf-c
    sources:
      - type: git
        url: https://github.com/Unidata/netcdf-c.git
        tag: v4.9.0 #works with hdf5 1.13.2
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
#
  - name: swig #gdal recommended
    sources:
      - type: git
        url: https://github.com/swig/swig.git
        tag: v4.1.1
    buildsystem: simple
    builddir: true
    build-commands:
      - ./autogen.sh
      - ./configure --prefix=/app --with-tclconfig=/app/lib
      - make
      - make install
#
  - name: gdal
    sources:
      - type: git
        url: https://github.com/OSGeo/gdal.git
        tag: v3.6.2
    buildsystem: cmake-ninja
    builddir: true #recommended
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
      - "-DGDAL_USE_OPENCL=ON"
      - "-DBUILD_TESTING=OFF"
#
  - name: grass
    sources:
      - type: git
        url: https://github.com/OSGeo/grass.git
        tag: 8.2.1
    buildsystem: simple
    builddir: true
    build-commands:
      - ./configure --prefix=/app --with-proj-share=/app/share/proj --with-nls --with-readline --with-pthread --with-opencl --with-bzlib --with-gdal --with-netcdf --with-geos
      - make
      - make install
#
  - name: protobuf
    sources:
      - type: git
        url: https://github.com/protocolbuffers/protobuf.git
        tag: v21.12
    buildsystem: cmake-ninja
    builddir: true #recommended
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
      - "-Dprotobuf_BUILD_SHARED_LIBS=ON"
      - "-Dprotobuf_BUILD_TESTS=OFF"
#
  - name: exiv2
    sources:
      - type: git
        url: https://github.com/Exiv2/exiv2.git
        tag: v0.27.6
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
      - "-DBUILD_WITH_CCACHE=ON"
      - "-DEXIV2_BUILD_SAMPLES=OFF"
      - "-DEXIV2_BUILD_UNIT_TESTS=OFF"
#
  - name: sip
    sources:
      - type: archive
        url: https://www.riverbankcomputing.com/static/Downloads/sip/4.19.25/sip-4.19.25.tar.gz
        sha256: b39d93e937647807bac23579edbff25fe46d16213f708370072574ab1f1b4211
    buildsystem: simple
    builddir: true
    build-commands:
      - python3 configure.py --sip-module PyQt5.sip -b /app/bin -d /app/lib/python3.10/site-packages -e /app/include -v /app/share/sip --stubsdir=/app/lib/python3.10/site-packages
      - make
      - make install
#
  - name: pyqt5
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/28/6c/640e3f5c734c296a7193079a86842a789edb7988dca39eab44579088a1d1/PyQt5-5.15.2.tar.gz
        sha256: 372b08dc9321d1201e4690182697c5e7ffb2e0770e6b4a45519025134b12e4fc
    buildsystem: simple
    builddir: true
    build-commands:
      - python3 configure.py --assume-shared --confirm-license --no-designer-plugin --no-qml-plugin --sysroot=/app --qsci-api --qsci-api-destdir=/app/qsci --sipdir=/app/share/sip --sip=/app/bin/sip --sip-incdir=/app/include QMAKE_CFLAGS_RELEASE='-I/usr/include/python3.10/' QMAKE_CXXFLAGS_RELEASE='-I/usr/include/python3.10/'
      - make
      - make install
#
  - name: qscintilla
    sources:
      - type: archive
        url: https://www.riverbankcomputing.com/static/Downloads/QScintilla/2.11.6/QScintilla-2.11.6.tar.gz
        sha256: e7346057db47d2fb384467fafccfcb13aa0741373c5d593bc72b55b2f0dd20a7
      - type: shell
        commands:
          - sed -i 's/\$\$\[QT_INSTALL_LIBS\]/\/app\/lib/g' Qt4Qt5/qscintilla.pro
          - sed -i 's/\$\$\[QT_INSTALL_HEADERS\]/\/app\/include/g' Qt4Qt5/qscintilla.pro
          - sed -i 's/\$\$\[QT_INSTALL_TRANSLATIONS\]/\/app\/share\/qt5\/translations/g' Qt4Qt5/qscintilla.pro
          - sed -i 's/\$\$\[QT_INSTALL_DATA\]/\/app\/share\/qt5/g' Qt4Qt5/qscintilla.pro
          - sed -i 's/\$\$\[QT_HOST_DATA\]/\/app\/lib\/qt5/g' Qt4Qt5/qscintilla.pro
    buildsystem: qmake
    builddir: true
    subdir: Qt4Qt5
#
  - name: qscintilla-bindings
    sources:
      - type: archive
        url: https://www.riverbankcomputing.com/static/Downloads/QScintilla/2.11.6/QScintilla-2.11.6.tar.gz
        sha256: e7346057db47d2fb384467fafccfcb13aa0741373c5d593bc72b55b2f0dd20a7
    buildsystem: simple
    builddir: true
    build-commands:
      - >
            sed -i "s/qmake = {'CONFIG': 'qscintilla2'}/qmake = {'CONFIG': 'qscintilla2', 'QT': 'widgets printsupport'}/g" Python/configure.py
      - cd Python && python3 configure.py --pyqt=PyQt5 --pyqt-sipdir=/app/share/sip --qsci-incdir=/app/include --qsci-libdir=/app/lib --destdir=/app/lib/python3.10/site-packages/PyQt5 --apidir=/app/share/qt5/qsci --stubsdir=/app/lib/python3.10/site-packages/PyQt5 --no-dist-info
      - echo LIBS += /app/lib/libqscintilla2_qt5.so >> Python/Qsci/Qsci.pro
      - cd Python && make && make install
#
  - name: qwt
    sources:
      - type: archive
        url: https://sourceforge.net/projects/qwt/files/qwt/6.2.0/qwt-6.2.0.zip
        sha256: 3e9632a9be6a883db5c496e42ce74cbbf8da02cc3328faa89e2c43e434a2eb76
      - type: shell
        commands:
          - sed -i 's/\$\$\[QT_INSTALL_PREFIX\]/\/app/g' qwtconfig.pri
          - sed -i 's/usr\/local\/qwt-\$\$QWT_VERSION/app/g' qwtconfig.pri
          - sed -i '/QwtExamples/s/^/#/g' qwtconfig.pri
          - sed -i '/QwtPlayground/s/^/#/g' qwtconfig.pri
          - sed -i '/QwtTests/s/^/#/g' qwtconfig.pri
    buildsystem: qmake
    builddir: true
#
  - name: qca
    sources:
      - type: git
        url: https://github.com/KDE/qca.git
        tag: v2.3.5
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
      - "-DBUILD_TESTS=OFF"
#
  - name: kadas-qgis
    sources:
      - type: git
        url: https://github.com/kadas-albireo/QGIS.git
        tag: final-3_28_2-kadas
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
      - "-DUSE_CCACHE=ON"
      - "-DGRASS_PREFIX8=/app/grass82"
      - "-DSIP_GLOBAL_INSTALL=TRUE"
      - "-DENABLE_TESTS=FALSE"
#
  - name: geographiclib
    sources:
      - type: git
        url: https://github.com/geographiclib/geographiclib.git
        tag: v2.1.2
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
#
  - name: svg2svgt
    sources:
      - type: git
        url: https://github.com/manisandro/svg2svgt.git
        #tag: v0.9.6
        branch: master #fixes error with ‘QPainterPath roundedRect’
        commit: cc180f65001b3859015e29589897b2412ac01042
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
#
  - name: zonedetect
    sources:
      - type: git
        url: https://github.com/BertoldVdb/ZoneDetect.git
        branch: master
        commit: 88e927d2302966993724f06d57e89cc4bf6d5e35
    buildsystem: simple
    builddir: true
    subdir: library
    build-commands:
      - prefix=/app make
      - prefix=/app make install
#
  - name: gdbcrashhandler
    sources:
      - type: git
        url: https://github.com/manisandro/GdbCrashHandler.git
        #tag: 0.3.0
        branch: master #works with quazip 1.x
        commit: ea2e7b677c4e33a1f2ce554c620d0b7b9b6242f3
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
#
  - name: kadas-about-plugin
    sources:
      - type: git
        url: https://github.com/kadas-albireo/kadas-about-plugin.git
        branch: master
        commit: faeca163cd2b6d1f1d0bd7247dfca6ddea412c3a
    buildsystem: simple
    builddir: true
    build-commands:
      - mkdir -p /app/share/kadas/python/plugins
      - cp -r kadas_* /app/share/kadas/python/plugins
#
  - name: kadas-help-plugin
    sources:
      - type: git
        url: https://github.com/kadas-albireo/kadas-help-plugin.git
        branch: master
        commit: c8592efa8d4a3ad495853bfad2a25fb7d8e89183
    buildsystem: simple
    builddir: true
    build-commands:
      - mkdir -p /app/share/kadas/python/plugins
      - cp -r kadas_* /app/share/kadas/python/plugins
#
  - name: kadas-gpkg-plugin
    sources:
      - type: git
        url: https://github.com/kadas-albireo/kadas-gpkg-plugin.git
        branch: master
        commit: 7e40559c86bfe7479782095cb07941c10d4505a2
    buildsystem: simple
    builddir: true
    build-commands:
      - mkdir -p /app/share/kadas/python/plugins
      - cp -r kadas_* /app/share/kadas/python/plugins
#
  - name: kadas-print-plugin
    sources:
      - type: git
        url: https://github.com/kadas-albireo/kadas-print-plugin.git
        branch: master
        commit: 1cdc570b65db8f7df1fdc616885ee0bab3b74faa
    buildsystem: simple
    builddir: true
    build-commands:
      - mkdir -p /app/share/kadas/python/plugins
      - cp -r kadas_* /app/share/kadas/python/plugins
#
  - name: kadas-albireo2
    sources:
      - type: git
        url: https://github.com/kadas-albireo/kadas-albireo2.git
        branch: master
        commit: 9c1f14d06b11b61c87994e4192de8930782a2387
      - type: shell #quick and ugly fix for versioning
        commands:
          - EPOCH=$(date +%s) && DATE=$(date -I) && sed -i "s/1580472000/$EPOCH/g" com.sourcepole.kadas.appdata.xml && sed -i "s/v2.0.0-rc1/$DATE/g" com.sourcepole.kadas.appdata.xml
      - type: shell #prevent installing to site-packages in /usr
        commands:
          - sed -i 's/\${Python_SITEARCH}/\/app\/lib\/python3.10\/site-packages/g' cmake/FindPyQt5.cmake
          - sed -i 's/\${Python_SITEARCH}/\/app\/lib\/python3.10\/site-packages/g' cmake/SIPMacros.cmake
          - sed -i 's/\${Python_SITEARCH}/\/app\/lib\/python3.10\/site-packages/g' python/CMakeLists.txt
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/app"
      - "-DCMAKE_PREFIX_PATH=/app;/usr"
      - "-DQGIS_PREFIX_PATH=/app"
      - "-DQGIS_PLUGIN_DIR=/app/lib/qgis/plugins" #fails finding file, libplugin_offlineediting.so = libofflineeditingplugin.so ?
      - "-DQGIS_SIP_DIR=/app/share/sip/qgis"
      - "-DWITH_GLOBE=OFF" #fails on osgearth Style if ON, removes dependencies on osg and osgearth
      - "-DINSTALL_DEMO_DATA=ON"
#
